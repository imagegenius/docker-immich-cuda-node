#!/usr/bin/with-contenv bash

mkdir -p /config/machine-learning

# apply early ml support
cp /defaults/main.py /app/immich/machine-learning/src/main.py
if [ ! -d /config/cuda-venv ]; then
    python3 -m venv /config/cuda-venv/
fi

# install/update pip packages to /config venv
source /config/cuda-venv/bin/activate

pip install -U --no-cache-dir --index-url https://download.pytorch.org/whl/cu117 \
    torch

pip install -U --no-cache-dir \
    aiocache \
    fastapi \
    insightface \
    nltk \
    numpy \
    onnxruntime-gpu \
    optimum \
    Pillow \
    scikit-learn \
    scipy \
    sentencepiece \
    sentence-transformers \
    tqdm \
    transformers \
    uvicorn[standard]
pip install -U --no-cache-dir nvidia-pyindex
pip install -U --no-cache-dir onnx-graphsurgeon

# permissions
chown -R abc:abc \
    /config \
    /app
